# é“¶è¡Œå¡è®¾ç½®é»˜è®¤åŠŸèƒ½

**å®Œæˆæ—¶é—´**: 2025-11-18 14:52  
**åŠŸèƒ½**: æ·»åŠ è®¾ç½®é»˜è®¤é“¶è¡Œå¡çš„åŠŸèƒ½

---

## âœ¨ æ–°å¢åŠŸèƒ½

### åŠŸèƒ½æ¦‚è¿°
- âœ… æ˜¾ç¤ºé»˜è®¤å¡æ ‡ç­¾
- âœ… ä¸ºéé»˜è®¤å¡æ˜¾ç¤º"è®¾ä¸ºé»˜è®¤"æŒ‰é’®
- âœ… ç‚¹å‡»æŒ‰é’®å¯å°†é“¶è¡Œå¡è®¾ä¸ºé»˜è®¤
- âœ… è‡ªåŠ¨æ›´æ–°åˆ—è¡¨æ˜¾ç¤º

---

## ğŸ¨ UIè®¾è®¡

### å¡ç‰‡å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¸­å›½å·¥å•†é“¶è¡Œ  [é»˜è®¤]         ğŸ—‘ï¸    â”‚ â† é»˜è®¤å¡æ˜¾ç¤ºæ ‡ç­¾
â”‚                                      â”‚
â”‚ 6222 ******** 7890                  â”‚
â”‚                                      â”‚
â”‚ å¼ ä¸‰                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¸­å›½å»ºè®¾é“¶è¡Œ                  ğŸ—‘ï¸    â”‚ â† éé»˜è®¤å¡
â”‚                                      â”‚
â”‚ 6217 ******** 5678                  â”‚
â”‚                                      â”‚
â”‚ å¼ ä¸‰              [è®¾ä¸ºé»˜è®¤]        â”‚ â† è®¾ä¸ºé»˜è®¤æŒ‰é’®
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. åç«¯API

**æ–‡ä»¶**: `backend/internal/api/v1/bank_card.go`

**æ–°å¢è·¯ç”±**:
```go
// PUT /bank-cards/:id/default - è®¾ç½®é»˜è®¤é“¶è¡Œå¡
rg.PUT("/bank-cards/:id/default", func(c *gin.Context) {
    cardID, _ := strconv.ParseUint(c.Param("id"), 10, 32)
    userID := c.GetUint("user_id")
    
    if err := cardSvc.SetDefaultCard(userID, uint(cardID)); err != nil {
        c.JSON(http.StatusBadRequest, gin.H{"error": err.Error()})
        return
    }
    
    c.JSON(http.StatusOK, gin.H{"message": "å·²è®¾ä¸ºé»˜è®¤é“¶è¡Œå¡"})
})
```

**ä¸šåŠ¡é€»è¾‘** (å·²å­˜åœ¨):
```go
// backend/internal/service/bank_card_service.go
func (s *BankCardService) SetDefaultCard(userID uint, cardID uint) error {
    // 1. æŸ¥æ‰¾é“¶è¡Œå¡
    card, err := s.cardRepo.FindByID(cardID)
    if err != nil {
        return errors.New("é“¶è¡Œå¡ä¸å­˜åœ¨")
    }
    
    // 2. éªŒè¯å½’å±
    if card.UserID != userID {
        return errors.New("æ— æƒæ“ä½œæ­¤é“¶è¡Œå¡")
    }
    
    // 3. å¼€å¯äº‹åŠ¡
    tx := s.ctx.DB.Begin()
    
    // 4. å–æ¶ˆæ‰€æœ‰é»˜è®¤å¡
    if err := s.cardRepo.UnsetAllDefault(userID); err != nil {
        tx.Rollback()
        return err
    }
    
    // 5. è®¾ç½®æ–°é»˜è®¤å¡
    card.SetAsDefault()
    if err := tx.Save(card).Error; err != nil {
        tx.Rollback()
        return err
    }
    
    tx.Commit()
    return nil
}
```

---

### 2. å‰ç«¯å®ç°

**æ–‡ä»¶**: `frontend/src/pages/BankCards.vue`

#### æ¨¡æ¿éƒ¨åˆ†

```vue
<div v-for="card in cards" :key="card.id || card.ID" class="card-item">
  <div class="card-header">
    <!-- é“¶è¡Œåç§°å’Œé»˜è®¤æ ‡ç­¾ -->
    <div class="bank-info">
      <span class="bank-name">{{ card.bank_name || card.BankName }}</span>
      <van-tag v-if="card.is_default || card.IsDefault" type="success" size="small">
        é»˜è®¤
      </van-tag>
    </div>
    <!-- åˆ é™¤æŒ‰é’® -->
    <van-icon name="delete-o" @click="deleteCard(card.id || card.ID)" />
  </div>
  
  <!-- å¡å· -->
  <div class="card-number">
    {{ formatCardNumber(card.card_number || card.CardNumber) }}
  </div>
  
  <!-- æŒå¡äººå’Œè®¾ä¸ºé»˜è®¤æŒ‰é’® -->
  <div class="card-footer">
    <div class="card-holder">{{ card.card_holder || card.CardHolder }}</div>
    <!-- éé»˜è®¤å¡æ˜¾ç¤ºè®¾ä¸ºé»˜è®¤æŒ‰é’® -->
    <van-button 
      v-if="!(card.is_default || card.IsDefault)" 
      size="small" 
      type="primary"
      @click="setDefaultCard(card.id || card.ID)"
    >
      è®¾ä¸ºé»˜è®¤
    </van-button>
  </div>
</div>
```

#### JavaScriptéƒ¨åˆ†

```javascript
/**
 * è®¾ç½®é»˜è®¤é“¶è¡Œå¡
 * @async
 * @param {number} id - é“¶è¡Œå¡ID
 * @returns {Promise<void>}
 */
const setDefaultCard = async (id) => {
  try {
    await request.put(`/api/v1/bank-cards/${id}/default`)
    showToast('å·²è®¾ä¸ºé»˜è®¤é“¶è¡Œå¡')
    loadCards()  // åˆ·æ–°åˆ—è¡¨
  } catch (error) {
    console.error('è®¾ç½®é»˜è®¤é“¶è¡Œå¡å¤±è´¥:', error)
    const errorMsg = error.response?.data?.error || error.response?.data?.message || 'è®¾ç½®å¤±è´¥'
    showToast(errorMsg)
  }
}
```

#### æ ·å¼éƒ¨åˆ†

```css
.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.bank-info {
  display: flex;
  align-items: center;
  gap: 8px;  /* é“¶è¡Œåç§°å’Œæ ‡ç­¾ä¹‹é—´çš„é—´è· */
}

.card-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.card-holder {
  font-size: 14px;
  opacity: 0.9;
}
```

---

## ğŸ¯ ä¸šåŠ¡æµç¨‹

### è®¾ç½®é»˜è®¤å¡æµç¨‹

```
ç”¨æˆ·ç‚¹å‡»"è®¾ä¸ºé»˜è®¤"æŒ‰é’®
    â†“
å‰ç«¯å‘é€PUTè¯·æ±‚
    â†“
åç«¯éªŒè¯ç”¨æˆ·æƒé™
    â†“
æŸ¥æ‰¾ç›®æ ‡é“¶è¡Œå¡
    â†“
éªŒè¯å¡å½’å±
    â†“
å¼€å¯æ•°æ®åº“äº‹åŠ¡
    â†“
å–æ¶ˆæ‰€æœ‰é»˜è®¤å¡ (is_default = false)
    â†“
è®¾ç½®æ–°é»˜è®¤å¡ (is_default = true)
    â†“
æäº¤äº‹åŠ¡
    â†“
è¿”å›æˆåŠŸ
    â†“
å‰ç«¯æ˜¾ç¤ºæç¤º"å·²è®¾ä¸ºé»˜è®¤é“¶è¡Œå¡"
    â†“
åˆ·æ–°é“¶è¡Œå¡åˆ—è¡¨
    â†“
UIæ›´æ–°æ˜¾ç¤º
```

---

## ğŸ“Š APIè¯¦æƒ…

### è®¾ç½®é»˜è®¤é“¶è¡Œå¡

**ç«¯ç‚¹**: `PUT /api/v1/bank-cards/:id/default`

**è¯·æ±‚**:
```http
PUT /api/v1/bank-cards/5/default HTTP/1.1
Host: localhost:8080
Authorization: Bearer YOUR_JWT_TOKEN
```

**å“åº”ï¼ˆæˆåŠŸï¼‰**:
```json
{
  "message": "å·²è®¾ä¸ºé»˜è®¤é“¶è¡Œå¡"
}
```

**å“åº”ï¼ˆé”™è¯¯ï¼‰**:
```json
// é“¶è¡Œå¡ä¸å­˜åœ¨
{
  "error": "é“¶è¡Œå¡ä¸å­˜åœ¨"
}

// æ— æƒæ“ä½œ
{
  "error": "æ— æƒæ“ä½œæ­¤é“¶è¡Œå¡"
}
```

---

## ğŸ§ª æµ‹è¯•åœºæ™¯

### åœºæ™¯1: è®¾ç½®é»˜è®¤å¡

**å‰æ**: æœ‰2å¼ é“¶è¡Œå¡ï¼Œå½“å‰é»˜è®¤å¡æ˜¯å¡A

**æ­¥éª¤**:
1. æ‰“å¼€é“¶è¡Œå¡ç®¡ç†é¡µé¢
2. æ‰¾åˆ°å¡Bï¼ˆéé»˜è®¤å¡ï¼‰
3. ç‚¹å‡»"è®¾ä¸ºé»˜è®¤"æŒ‰é’®

**é¢„æœŸç»“æœ**:
- âœ… æç¤º"å·²è®¾ä¸ºé»˜è®¤é“¶è¡Œå¡"
- âœ… å¡Bæ˜¾ç¤º"é»˜è®¤"æ ‡ç­¾
- âœ… å¡Açš„"é»˜è®¤"æ ‡ç­¾æ¶ˆå¤±
- âœ… å¡Aæ˜¾ç¤º"è®¾ä¸ºé»˜è®¤"æŒ‰é’®

---

### åœºæ™¯2: åˆ é™¤éé»˜è®¤å¡åçš„é»˜è®¤å¡

**å‰æ**: æœ‰2å¼ å¡ï¼Œå¡Aæ˜¯é»˜è®¤å¡

**æ­¥éª¤**:
1. åˆ é™¤å¡Bï¼ˆéé»˜è®¤å¡ï¼‰
2. æŸ¥çœ‹å¡AçŠ¶æ€

**é¢„æœŸç»“æœ**:
- âœ… å¡Aä»ç„¶æ˜¯é»˜è®¤å¡
- âœ… å¡Aä¸æ˜¾ç¤º"è®¾ä¸ºé»˜è®¤"æŒ‰é’®
- âœ… å¯ä»¥ç›´æ¥åˆ é™¤å¡Aï¼ˆå› ä¸ºæ˜¯å”¯ä¸€çš„å¡ï¼‰

---

### åœºæ™¯3: å¿«é€Ÿåˆ‡æ¢é»˜è®¤å¡

**å‰æ**: æœ‰3å¼ å¡

**æ­¥éª¤**:
1. è®¾ç½®å¡Aä¸ºé»˜è®¤
2. ç«‹å³è®¾ç½®å¡Bä¸ºé»˜è®¤
3. å†è®¾ç½®å¡Cä¸ºé»˜è®¤

**é¢„æœŸç»“æœ**:
- âœ… æ¯æ¬¡åˆ‡æ¢éƒ½æˆåŠŸ
- âœ… åªæœ‰æœ€åè®¾ç½®çš„å¡Cæ˜¾ç¤ºä¸ºé»˜è®¤
- âœ… å…¶ä»–å¡éƒ½æ˜¾ç¤º"è®¾ä¸ºé»˜è®¤"æŒ‰é’®

---

## ğŸ’¡ äº¤äº’ç»†èŠ‚

### 1. æŒ‰é’®çŠ¶æ€

| å¡ç‰‡çŠ¶æ€ | æ˜¾ç¤ºæ ‡ç­¾ | æ˜¾ç¤ºæŒ‰é’® |
|---------|---------|---------|
| é»˜è®¤å¡ | âœ… "é»˜è®¤" | âŒ |
| éé»˜è®¤å¡ | âŒ | âœ… "è®¾ä¸ºé»˜è®¤" |

### 2. æŒ‰é’®æ ·å¼

- **ç±»å‹**: Primaryï¼ˆä¸»è¦æŒ‰é’®ï¼‰
- **å¤§å°**: Smallï¼ˆå°å·ï¼‰
- **ä½ç½®**: å¡ç‰‡å³ä¸‹è§’
- **é¢œè‰²**: è“è‰²ï¼ˆVantä¸»é¢˜è‰²ï¼‰

### 3. æ ‡ç­¾æ ·å¼

- **ç±»å‹**: Successï¼ˆæˆåŠŸæ ‡ç­¾ï¼‰
- **å¤§å°**: Smallï¼ˆå°å·ï¼‰
- **ä½ç½®**: é“¶è¡Œåç§°å³ä¾§
- **é¢œè‰²**: ç»¿è‰²

---

## ğŸ”„ æ•°æ®åº“å˜åŒ–

### è®¾ç½®é»˜è®¤å¡å‰

```sql
SELECT id, bank_name, is_default FROM bank_cards WHERE user_id = 1;

+----+----------+-----------+
| id | bank_name | is_default |
+----+----------+-----------+
|  1 | å·¥å•†é“¶è¡Œ  | true       |  â† å½“å‰é»˜è®¤
|  2 | å»ºè®¾é“¶è¡Œ  | false      |
+----+----------+-----------+
```

### è®¾ç½®é»˜è®¤å¡åï¼ˆè®¾ç½®å¡2ä¸ºé»˜è®¤ï¼‰

```sql
SELECT id, bank_name, is_default FROM bank_cards WHERE user_id = 1;

+----+----------+-----------+
| id | bank_name | is_default |
+----+----------+-----------+
|  1 | å·¥å•†é“¶è¡Œ  | false      |  â† å–æ¶ˆé»˜è®¤
|  2 | å»ºè®¾é“¶è¡Œ  | true       |  â† æ–°é»˜è®¤
+----+----------+-----------+
```

---

## âœ… åŠŸèƒ½å®Œæˆ

### ä¿®æ”¹çš„æ–‡ä»¶

1. âœ… `backend/internal/api/v1/bank_card.go`
   - æ·»åŠ  PUT /bank-cards/:id/default è·¯ç”±

2. âœ… `frontend/src/pages/BankCards.vue`
   - æ·»åŠ é»˜è®¤æ ‡ç­¾æ˜¾ç¤º
   - æ·»åŠ "è®¾ä¸ºé»˜è®¤"æŒ‰é’®
   - æ·»åŠ setDefaultCardæ–¹æ³•
   - æ·»åŠ ç›¸å…³æ ·å¼

### åŠŸèƒ½çŠ¶æ€

- âœ… æ˜¾ç¤ºé»˜è®¤å¡æ ‡ç­¾
- âœ… æ˜¾ç¤ºè®¾ä¸ºé»˜è®¤æŒ‰é’®ï¼ˆéé»˜è®¤å¡ï¼‰
- âœ… ç‚¹å‡»æŒ‰é’®è®¾ç½®é»˜è®¤å¡
- âœ… è‡ªåŠ¨åˆ·æ–°åˆ—è¡¨
- âœ… é”™è¯¯æç¤ºæ­£å¸¸

---

## ğŸš€ æµ‹è¯•æ­¥éª¤

### 1. é‡å¯åç«¯æœåŠ¡

```powershell
# åœæ­¢åç«¯
Ctrl + C

# é‡æ–°å¯åŠ¨
cd e:\AI\SuxinZK\code\backend
go run cmd/server/main.go
```

### 2. åˆ·æ–°å‰ç«¯

```
Ctrl + Shift + R
```

### 3. æµ‹è¯•åŠŸèƒ½

1. è®¿é—® http://localhost:5173/bank-cards
2. æŸ¥çœ‹é»˜è®¤å¡æ˜¯å¦æ˜¾ç¤º"é»˜è®¤"æ ‡ç­¾
3. æŸ¥çœ‹éé»˜è®¤å¡æ˜¯å¦æ˜¾ç¤º"è®¾ä¸ºé»˜è®¤"æŒ‰é’®
4. ç‚¹å‡»"è®¾ä¸ºé»˜è®¤"æŒ‰é’®
5. éªŒè¯æ˜¯å¦æˆåŠŸåˆ‡æ¢

---

## ğŸ“¸ é¢„æœŸæ•ˆæœ

### æœ‰é»˜è®¤å¡æ—¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¸­å›½å·¥å•†é“¶è¡Œ  âœ…é»˜è®¤          ğŸ—‘ï¸    â”‚
â”‚                                      â”‚
â”‚ 6222 ******** 7890                  â”‚
â”‚                                      â”‚
â”‚ å¼ ä¸‰                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¸­å›½å»ºè®¾é“¶è¡Œ                  ğŸ—‘ï¸    â”‚
â”‚                                      â”‚
â”‚ 6217 ******** 5678                  â”‚
â”‚                                      â”‚
â”‚ æå››              [è®¾ä¸ºé»˜è®¤] â†ç‚¹å‡»è¿™é‡Œâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åˆ‡æ¢é»˜è®¤å¡å

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¸­å›½å·¥å•†é“¶è¡Œ                  ğŸ—‘ï¸    â”‚
â”‚                                      â”‚
â”‚ 6222 ******** 7890                  â”‚
â”‚                                      â”‚
â”‚ å¼ ä¸‰              [è®¾ä¸ºé»˜è®¤]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä¸­å›½å»ºè®¾é“¶è¡Œ  âœ…é»˜è®¤          ğŸ—‘ï¸    â”‚
â”‚                                      â”‚
â”‚ 6217 ******** 5678                  â”‚
â”‚                                      â”‚
â”‚ æå››                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**é‡å¯åç«¯æœåŠ¡ï¼Œåˆ·æ–°æµè§ˆå™¨æµ‹è¯•è®¾ç½®é»˜è®¤å¡åŠŸèƒ½ï¼** ğŸ‰
